# JVM

JVM 是一个虚构出来的计算机，一种规范，通过在实际的计算机上仿真模拟各类计算机功能实现

## Java 5 大块

- 类加载器：用于加载 .class 文件到 JVM 中
- 方法区：存放元信息(类信息，常量，静态变量，JIT 优化缓存)
- 堆：存放几乎所有对象，与方法区都是线程共享(线程不安全)
- 栈：调用方法会在栈中运行
- 程序计数器：线程内的程序计数器，用于记录代码运行到哪里，与栈一样是线程独享的

![](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2020/1/9/16f8ab42da5a81cd~tplv-t2oaga2asx-jj-mark:3024:0:0:0:q75.png)

### Java 文件运行流程

1. 编译 .java 文件后执行，JVM 会启动一条线程
2. 类加载器在 classpath 路径下将对应的 .class 文件加载到 JVM，相应的类信息存入运行时数据区的方法区
3. JVM 找到主程序入口执行 main 方法
4. 对于 new 操作：
   1. 先将对应的 .class 文件加载
   2. 在堆中分配内存空间
   3. 调用构造函数初始化
   4. 生成的实例持有指向方法区中的对应类信息的引用
5. 执行实例方法：
   1. 由引用找到堆中的类实例
   2. 由实例持有的类信息引用找到对应方法的字节码地址(方法表)
   3. 执行对应方法

## 类加载器

类加载器只负责将 .class 文件的字节码内容加载到 JVM，将其转换为方法区中的运行时数据结构，并不关心加载的类是否能够运行

### 类加载流程

1. 加载：将 .class 文件加载进内存，转换为运行时数据结构存储在方法区，在堆中生成对应的 Class 对象
2. 链接：
   1. 检查：检查类是否符合 JVM 规范，类方法是否会产生危害 JVM 的行为
   2. 准备：类静态变量的内存分配与初始化(默认值)
   3. 解析：将常量池内的符号引用(字面量)替换为实际引用(即将 apple 替换为对象实际的内存地址)
3. 初始化：顺序执行
   1. 静态变量的显示初始化
   2. 静态代码块
   3. 父类构造函数
   4. 子类构造函数
4. 使用
5. 卸载：GC 回收

### 类加载器的加载顺序

1. BootStrap：根加载器
2. Extension：扩展加载器
3. App：指定 classpath 的加载器
4. Custom：自定义加载器

### 双亲委派机制

在一个类需要加载时，首先调用底层的类加载器(根加载器，加载器的父类)，若无法加载再逐层调用子加载器

由此可以确保不同的类加载器加载的结果一致，且用户自定义的类不会覆盖 JDK 自身的类

## 运行时方法区

### 程序计数器

指向下一条字节码指令行号的指针，JVM 通过改变程序计数器来选取下一条需要指向的字节码指令

程序计数器是内存空间中唯一不会出现 OOM 的区域，且在执行 native 方法时无效

### 本地方法栈

存放 native 方法的栈

### 方法区

存放元信息的内存区域，如：类信息、静态变量、JIT 优化缓存、常量等

### 虚拟机栈

虚拟机栈是方法运行的内存模型，会存储方法的局部变量表、动态链接、方法出口、入栈出栈操作

#### 生命周期

方法执行完毕后出栈，相关内存空间自动释放，故不需要 GC

基本数据类型、逃逸分析、对象引用、实例方法都存储在栈中

#### 执行

方法通过栈帧的形式存储在虚拟机栈中，方法开始执行即入栈，结束执行即出栈，栈的操作符合先入后出的规则

#### 局部变量表的复用

局部变量表用于按照特定顺序存储方法参数与局部变量，其存储的单位为小于 32 位的 slot，当存储的变量超过其作用域(不再被使用)时，该 slot 可以被其他变量重用，垃圾回收器不会回收此内存

### 虚拟机堆

堆主要用于存储实例对象

JVM 内存区域：

- 堆：
  - 年轻代
    - Eden
    - Survivor
      - FromPlace
      - ToPlace
  - 老年代
- 非堆:
  - 永久代(Java 8 后移除) --> 元空间(直接使用系统内存中)
    - 主要是为了和 JRockit VM 合并，但也解决了永久代频繁 OOM 的问题(难以设置永久代的大小，加载大量类时容易 OOM)