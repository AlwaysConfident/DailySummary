# Docker

Docker 是软件容器平台，由 Go 开发，基于 Linux 内核实现，对进程进行封装隔离，属于操作系统层面的虚拟化技术

Docker 能自动执行重复性任务(搭建与配置开发环境)

- 一致性：Docker 镜像包含除内核外运行所需的所有环境，保证应用的运行时环境一致
  - 迁移方便，无需考虑运行时环境的问题
  - 集成、交付、部署
- 快速启动：多个 Docker 容器共享系统内核，能够快速启动，占用较少的内存与 CPU 资源
- 隔离性：Docker 保证资源在公共服务器上不会受到其他用户的影响
- 弹性伸缩：善于处理流量激增的场景

Docker 的运行过程就是在仓库把镜像拉到本地，再由命令将镜像运行起来变为容器

## 容器

容器是将软件打包成标准化单元，以用于开发、交付和部署

- 轻量、可执行、独立：容器镜像包含软件运行所需的所有内容
- 平台无关：容器化软件在任何环境都能始终如一地运行
- 独立性：容器之间相互独立，在相同设施运行不同软件时不会发生冲突

### docker 容器

- 轻量：
  - Docker 容器共享操作系统内核，能够快速启动，且开销较小
  - 镜像通过文件系统层进行构造，共享一些公共文件，减少磁盘开销，且能快速下载镜像
- 标准：Docker 容器基于开放式标准，能够运行在任何基础设施
- 安全：Docker 容器之间相互独立，容器与底层设施之间独立，即一个容器崩溃，对于其他容器和整个系统没有影响

### 容器 vs 虚拟机

- 容器：虚拟化操作系统，容器之间共享同一套操作系统资源，但各自作为独立的进程在用户空间中运行，占用空间更小，启动速度更快
- 虚拟机：在虚拟的硬件上运行一个完整操作系统，隔离级别更高，占用空间更大，启动更慢

![](https://img-blog.csdnimg.cn/img_convert/9114e4a753de14a7531e867b908e6660.png)

## 镜像

Docker 镜像是一个特殊的文件系统：

- 静态：镜像提供容器运行所需的程序、库、资源、配置等文件，还包含一些运行时所需的配置参数(环境变量)，其内容在构建之后不会改变
- 分层存储：镜像会逐层构建，每一层都基于前一层构建，且构建完成后不会改变，每层的改变只会影响自身
  - 如删除上一层的文件只会将文件标记为已删除，而不会将上一层的文件删除，该文件在容器运行时不可见，但仍然存在，故在构建时应尽量确保每层只包含必要的文件
  - 镜像构建的过程就是执行 Dockerfile 文件中写入的命令，每执行一个步骤会生成一个随机 id 标识这一层的内容，最后一层的 id 作为镜像 id
  - 对于已经构建过的镜像层，Docker 会直接复用之前的结果
- 复用、定制：已经构建的镜像能够直接部署运行，新的镜像也能基于其他镜像进行构建

## 容器

- 镜像的实例：类比对象与实例，容器就是镜像的运行时实例，可以被创建、启动、停止、删除、暂停等
- 本质是进程：与直接在宿主执行的进程不同，容器进程运行于属于自身的独立命名空间
- 分层存储：容器也随镜像使用分层存储，且容器存储层的生命周期随容器，当容器消亡时，存储的信息也会随之消亡，因此不应向存储层写入数据
- 数据持久化：使用数据卷(Volume)，或绑定宿主目录来执行文件写入操作，这些位置的读写会跳过容器存储层，直接对宿主/网络存储进行读写，性能和稳定性更高
  - 数据卷实现宿主机与容器之间的文件共享，支持对宿主机文件的直接修改，而不需要再将宿主机文件复制到容器中
  - 数据卷的生命周期独立于容器，容器可以随意被删除、重启，数据不会丢失

## 仓库

仓库负责提供集中存储、分发镜像的服务，以便在其他服务器上使用镜像

Registry → Repository(仓库) → Tag(镜像)

类比代码仓库，镜像仓库也会对镜像进行版本管理，Tag 常用于标识软件的各个版本

## 底层原理

Docker 基于 Linux 命名空间、控制组、UnionFS 实现，Docker 使用 Linux 的隔离功能，让容器看起来像在一个轻量级虚拟机在独立运行，容器的本质是被限制的 namespace + cgroup，具有逻辑上的独立文件系统，网络的一个进程

Docker 通过创建 Linux 镜像将操作系统集成到 Docker 中，从而运行 Linux 应用

![](https://img-blog.csdnimg.cn/53de044ef67d4b1e9592a065645f778a.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBA5p625p6E5biILeWwvOaBqQ==,size_20,color_FFFFFF,t_70,g_se,x_16)

- 命名空间：即 Linux 的 namespace，用于容器间的隔离，不同命名空间之间相互独立，即容器的资源不共享
- 控制组：基于 Linux 的 cgroups 子系统，用于容器资源统计和隔离
- UnionFS：联合文件系统，用于把多个文件系统联合到同一个挂载点的文件系统服务
  - 文件目录联合后分为可读目录与可写目录，对可读目录进行写操作时，其结果会保存到可写目录下，不会影响只读目录
  - 使用这种读写分离的机制保证镜像分层构建存储时，当前层的修改不会影响上一层